# File for function

#import necessary moduls
from pathlib import Path
from cryptography.fernet import Fernet
import psycopg2
from psycopg2 import Binary

# connection with data base
def connect_db():
    conn = psycopg2.connect(database = 'Ps_manager',
                           user = 'zakhar',
                            host = 'localhost',
                            port = 5432)
    cur = conn.cursor()
    return(conn, cur)

#def close db
def disconnect_db(conn, cur):
    conn.commit()
    cur.close()
    conn.close()


# for change on main(first) page
def main_page():
    print(
            "\n\tHello, it's your pasword manager.\n"
            "\tWhat would you do?\n"
            "\n\tAdd password:          'a'"
            "\n\tGet password:          'g'"
            "\n\tExit:                  'q'"
            )
    return(input('\n\tYour change: '))



# check key
def get_fernet():
    key_path = Path('.key.txt')

    if not key_path.exists():
        key = Fernet.generate_key()
        key_path.write_bytes(key)
    else:
        key = key_path.read_bytes()
        if key == b'':
            key = Fernet.generate_key()
            key_path.write_bytes(key)

    return Fernet(key)

# add password
def add_passwd(f):

    name = (input("\n\tName servise: "))
    login = (input("\n\tLogin: "))
    password = (input("\n\tPassword: "))
    enc_password = f.encrypt((password).encode("utf-8"))

    print(enc_password)
    print(type(enc_password))
    
    # Here will be sending data in data base
    conn, cur = connect_db() #def for connect to data base
    cur.execute(
            "INSERT INTO Ps_manager (name, login, password) VALUES (%s, %s, %s)", (name, login, enc_password),
            )
    disconnect_db(conn, cur) #def for disconnect to data base
    print(
            "\n\tThis function in process"
            f"\n\tYour password: {password}"
            f"\n\tYour enc_password = {enc_password}"
          )


# def for get password by name
def get_by_name(name):
    conn, cur = connect_db() 
    cur.execute(f"SELECT * FROM Ps_manager WHERE name = '{name}';")
    rows = cur.fetchall()
    disconnect_db(conn, cur)
    name, login, pswd = rows[0]
    f = get_fernet()
    print(rows, name, login, bytes(pswd), f.decrypt(pswd).decode('utf-8'))
    


# def for get password by login
def get_by_login(login):
    print('In process...')

# funct for get password
def get_passwd():
    print("\n\tHow you want get your password?\n"
          "\n\tBy name:            'n'"
          "\n\tBy login:           'l'"
          )
    change = input("\n\tYour change: ").lower()
    if change == 'n':
        name = input('\n\tYour name: ')
        get_by_name(name)
    elif change == 'l':
        login = input('\n\tYour login: ')
        get_by_login(login)
    else:
        print('\n\tError input, try again.')
        get_passwd()
